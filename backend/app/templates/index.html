{% extends "base.html" %}

{% block content %}
<h1 class="mb-4">
    {% if page_type == 'renting_out' %}
    –°–¥–∞—é—Ç –∫–≤–∞—Ä—Ç–∏—Ä—É
    {% elif page_type == 'looking_for' %}
    –ò—â—É—Ç –∫–≤–∞—Ä—Ç–∏—Ä—É
    {% else %}
    –û–±–º–µ–Ω –∫–≤–∞—Ä—Ç–∏—Ä–∞–º–∏
    {% endif %}
</h1>

<div class="row">
    <div class="col-md-3 mb-4">
        <div class="card">
            <div class="card-header">
                –§–∏–ª—å—Ç—Ä—ã
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="city" class="form-label">–ì–æ—Ä–æ–¥</label>
                    <select class="form-select" id="city">
                        <option value="">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option>
                        {% set cities = [] %}
                        {% for listing in listings %}
                            {% if listing.city and listing.city not in cities %}
                                {% set _ = cities.append(listing.city) %}
                            {% endif %}
                        {% endfor %}
                        {% for city in cities|sort %}
                            <option value="{{ city }}">{{ city }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">–ü–µ—Ä–∏–æ–¥</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="date-range" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥" readonly>
                        <button class="btn btn-outline-secondary" type="button" id="clear-dates">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
                    <select class="form-select" id="sort">
                        <option value="date-desc">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                        <option value="date-asc">–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
                        <option value="price-asc">–°–Ω–∞—á–∞–ª–∞ –¥–µ—à–µ–≤—ã–µ</option>
                        <option value="date-match">–ü–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é –¥–∞—Ç</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-9">
        <div id="listings" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            {% for listing in listings %}
            <div class="col listing" data-date="{{ listing.date }}">
                <div class="card h-100 {% if listing.is_new %}new-listing{% endif %}">
                    <div class="listing-images">
                        {% if listing.photo_paths %}
                            {% if listing.photo_paths|length > 1 %}
                            <div id="carousel-{{ listing.id }}" class="carousel slide" data-bs-ride="false" data-bs-interval="false">
                                <div class="carousel-inner">
                                    {% for photo in listing.photo_paths %}
                                    <div class="carousel-item {% if loop.first %}active{% endif %}">
                                        <div class="image-container">
                                            <img src="{{ photo }}" class="d-block w-100 rounded-top" alt="–§–æ—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è" loading="lazy">
                                            <div class="image-counter">{{ loop.index }} / {{ listing.photo_paths|length }}</div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#carousel-{{ listing.id }}" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">–ü—Ä–µ–¥—ã–¥—É—â–µ–µ</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#carousel-{{ listing.id }}" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">–°–ª–µ–¥—É—é—â–µ–µ</span>
                                </button>
                            </div>
                            {% else %}
                            <div class="image-container">
                                <img src="{{ listing.photo_paths[0] }}" class="d-block w-100 rounded-top" alt="–§–æ—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è" loading="lazy">
                            </div>
                            {% endif %}
                        {% else %}
                        <div class="image-container placeholder">
                            <div class="placeholder-content">
                                <i class="placeholder-icon">üè†</i>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                {% if listing.is_new %}
                                <span class="badge bg-warning">New</span>
                                {% endif %}
                            </div>
                            <div>
                                {% if listing.price_eur %}
                                <span class="badge bg-success">{{ listing.price_eur|format_price }}</span>
                                {% endif %}
                            </div>
                        </div>
                        {% if listing.city or listing.country %}
                        <div class="location mb-2">
                            <small class="text-muted">
                                <i class="bi bi-geo-alt"></i>
                                {% if listing.city %}{{ listing.city }}{% endif %}
                                {% if listing.city and listing.country %},{% endif %}
                                {% if listing.country %} {{ listing.country }}{% endif %}
                            </small>
                        </div>
                        {% endif %}
                        {% if listing.rental_start or listing.rental_end %}
                        <div class="dates mb-2">
                            <small class="text-muted">
                                <i class="bi bi-calendar"></i>
                                {% if listing.rental_start %}—Å {{ listing.rental_start|format_date }}{% endif %}
                                {% if listing.rental_end %} –ø–æ {{ listing.rental_end|format_date }}{% endif %}
                            </small>
                        </div>
                        {% endif %}
                        <p class="card-text text-preview">{{ listing.text }}</p>
                        <div class="mt-auto text-center">
                            <a href="listings/{{ listing.id }}.html" class="btn btn-sm btn-outline-primary w-100">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const cityInput = document.getElementById('city');
    const dateRangeInput = document.getElementById('date-range');
    const sortSelect = document.getElementById('sort');
    const listings = document.getElementById('listings');

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    let datePicker = new Litepicker({
        element: dateRangeInput,
        format: 'DD.MM.YYYY',
        lang: 'ru-RU',
        numberOfMonths: 2,
        numberOfColumns: 2,
        singleMode: false,
        autoApply: true,
        showTooltip: true,
        tooltipText: {
            one: '–¥–µ–Ω—å',
            few: '–¥–Ω—è',
            many: '–¥–Ω–µ–π',
            other: '–¥–Ω–µ–π'
        },
        setup: (picker) => {
            picker.on('selected', (date1, date2) => {
                filterListings();
            });
            picker.on('clear', () => {
                filterListings();
            });
        }
    });

    function parseDate(dateStr) {
        if (!dateStr) return null;
        const parts = dateStr.split('.');
        if (parts.length !== 3) return null;
        // –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—É –≤ UTC –≤ –ø–æ–ª–Ω–æ—á—å
        return new Date(Date.UTC(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]), 0, 0, 0));
    }

    function hasDateOverlap(start1, end1, start2, end2) {
        // –ï—Å–ª–∏ –¥–∞—Ç—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã, —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –ø–µ—Ä–∏–æ–¥ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π
        if (!start1) start1 = new Date(-8640000000000000);
        if (!end1) end1 = new Date(8640000000000000);
        if (!start2) start2 = new Date(-8640000000000000);
        if (!end2) end2 = new Date(8640000000000000);
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—ã –≤ timestamp –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        start1 = start1.getTime();
        end1 = end1.getTime();
        start2 = start2.getTime();
        end2 = end2.getTime();
        
        return start1 <= end2 && start2 <= end1;
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏ –¥–∞—Ç
    document.getElementById('clear-dates').addEventListener('click', function() {
        datePicker.clearSelection();
    });

    // –ò–∑–º–µ–Ω—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è select –≥–æ—Ä–æ–¥–∞
    cityInput.addEventListener('change', filterListings);

    function filterListings() {
        const cityValue = cityInput.value;
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        let selectedDates = null;
        if (datePicker.getStartDate() && datePicker.getEndDate()) {
            selectedDates = {
                start: datePicker.getStartDate(),
                end: datePicker.getEndDate()
            };
        }
        
        const cards = document.querySelectorAll('.listing');
        let visibleCount = 0;
        
        cards.forEach(card => {
            const cityEl = card.querySelector('.location');
            const city = cityEl ? cityEl.textContent.trim() : '';
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—ã –∞—Ä–µ–Ω–¥—ã –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏
            const datesEl = card.querySelector('.dates');
            let rentalStart = null;
            let rentalEnd = null;
            
            if (datesEl) {
                const datesText = datesEl.textContent;
                const startMatch = datesText.match(/—Å\s+(\d{2}\.\d{2}\.\d{4})/);
                const endMatch = datesText.match(/–ø–æ\s+(\d{2}\.\d{2}\.\d{4})/);
                
                if (startMatch) {
                    rentalStart = parseDate(startMatch[1]);
                }
                
                if (endMatch) {
                    rentalEnd = parseDate(endMatch[1]);
                }
            }
            
            let showCard = true;
            
            // –§–∏–ª—å—Ç—Ä –ø–æ –≥–æ—Ä–æ–¥—É (—Ç–µ–ø–µ—Ä—å —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)
            if (cityValue) {
                showCard = city.includes(cityValue);
            }
            
            // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–∞–º
            if (showCard && selectedDates) {
                showCard = hasDateOverlap(
                    selectedDates.start,
                    selectedDates.end,
                    rentalStart,
                    rentalEnd
                );
            }
            
            card.style.display = showCard ? '' : 'none';
            if (showCard) visibleCount++;
        });

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        const noResultsMessage = document.getElementById('no-results-message');
        if (visibleCount === 0) {
            if (!noResultsMessage) {
                const message = document.createElement('div');
                message.id = 'no-results-message';
                message.className = 'alert alert-info mt-3';
                message.textContent = '–ù–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º';
                listings.parentNode.appendChild(message);
            }
        } else if (noResultsMessage) {
            noResultsMessage.remove();
        }
    }

    function getDateOverlapScore(start1, end1, start2, end2) {
        // –ï—Å–ª–∏ –Ω–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¥–∞—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 0
        if (!start1 || !end1) return 0;
        
        // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞—Ç –≤ –æ–±—ä—è–≤–ª–µ–Ω–∏–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
        if (!start2 || !end2) return -1;
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—ã –≤ timestamp
        start1 = start1.getTime();
        end1 = end1.getTime();
        start2 = start2.getTime();
        end2 = end2.getTime();
        
        // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ
        const overlapStart = Math.max(start1, start2);
        const overlapEnd = Math.min(end1, end2);
        
        if (overlapEnd < overlapStart) return 0;
        
        // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
        const millisecondsPerDay = 1000 * 60 * 60 * 24;
        const overlapDays = Math.floor((overlapEnd - overlapStart) / millisecondsPerDay) + 1;
        
        return overlapDays;
    }

    function extractPrice(priceElement) {
        if (!priceElement) return Infinity;
        const priceText = priceElement.textContent.trim();
        const match = priceText.match(/(\d+(?:\s\d+)*)/);
        if (!match) return Infinity;
        return parseInt(match[1].replace(/\s/g, ''));
    }

    function sortListings() {
        const cards = Array.from(document.querySelectorAll('.listing'));
        const sortOrder = sortSelect.value;
        
        cards.sort((a, b) => {
            if (sortOrder === 'date-desc' || sortOrder === 'date-asc') {
                const dateA = new Date(a.dataset.date + 'Z');
                const dateB = new Date(b.dataset.date + 'Z');
                return sortOrder === 'date-desc' ? dateB - dateA : dateA - dateB;
            }
            else if (sortOrder === 'price-asc') {
                const priceA = extractPrice(a.querySelector('.badge.bg-success'));
                const priceB = extractPrice(b.querySelector('.badge.bg-success'));
                return priceA - priceB;
            }
            else if (sortOrder === 'date-match' && datePicker.getStartDate() && datePicker.getEndDate()) {
                const selectedStart = datePicker.getStartDate();
                const selectedEnd = datePicker.getEndDate();
                
                const getDates = (card) => {
                    const datesEl = card.querySelector('.dates');
                    if (!datesEl) return [null, null];
                    
                    const datesText = datesEl.textContent;
                    const startMatch = datesText.match(/—Å\s+(\d{2}\.\d{2}\.\d{4})/);
                    const endMatch = datesText.match(/–ø–æ\s+(\d{2}\.\d{2}\.\d{4})/);
                    
                    return [
                        startMatch ? parseDate(startMatch[1]) : null,
                        endMatch ? parseDate(endMatch[1]) : null
                    ];
                };
                
                const [startA, endA] = getDates(a);
                const [startB, endB] = getDates(b);
                
                const scoreA = getDateOverlapScore(selectedStart, selectedEnd, startA, endA);
                const scoreB = getDateOverlapScore(selectedStart, selectedEnd, startB, endB);
                
                return scoreB - scoreA;
            }
            return 0;
        });
        
        cards.forEach(card => listings.appendChild(card));
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–ø–ª—ã–≤–∞—é—â–∏—Ö –ø–æ–¥—Å–∫–∞–∑–æ–∫ –¥–ª—è —Ç–µ–∫—Å—Ç–∞
    const textPreviews = document.querySelectorAll('.text-preview');
    textPreviews.forEach(preview => {
        const fullText = preview.textContent;
        if (fullText.length > 150) {
            preview.textContent = fullText.substring(0, 150) + '...';
            preview.title = fullText;
        }
    });

    cityInput.addEventListener('change', filterListings);
    sortSelect.addEventListener('change', sortListings);
});
</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/plugins/ranges.js"></script>

<style>
.image-container {
    background-color: #f8f9fa;
    position: relative;
    width: 100%;
    padding-top: 56.25%; /* 16:9 Aspect Ratio */
    overflow: hidden;
}

.image-container img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.image-counter {
    position: absolute;
    bottom: 10px;
    right: 10px;
    background-color: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    z-index: 2;
}

.carousel-control-prev,
.carousel-control-next {
    background-color: rgba(0, 0, 0, 0.5);
    width: 40px;
    height: 40px;
    border-radius: 20px;
    top: 50%;
    transform: translateY(-50%);
    margin: 0 10px;
    opacity: 0;
    transition: opacity 0.2s ease-in-out;
}

.carousel:hover .carousel-control-prev,
.carousel:hover .carousel-control-next {
    opacity: 1;
}

.carousel-control-prev-icon,
.carousel-control-next-icon {
    width: 24px;
    height: 24px;
}

.placeholder {
    background-color: #f8f9fa;
    border-bottom: 1px solid rgba(0,0,0,0.1);
}

.placeholder-content {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.placeholder-icon {
    font-size: 3rem;
    color: #dee2e6;
    font-style: normal;
}

.text-preview {
    font-size: 0.9rem;
    line-height: 1.4;
    max-height: 200px;
    overflow: hidden;
    cursor: help;
}

.card {
    transition: transform 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.badge {
    font-size: 0.75rem;
    padding: 0.5em 0.8em;
}

.badge.bg-success {
    font-size: 0.85rem;
}

#clear-dates {
    padding: 0.375rem 0.75rem;
}

#clear-dates i {
    margin: 0;
}

.new-listing {
    border: 2px solid #ffc107;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
@media (max-width: 992px) {
    .row-cols-lg-3 > * {
        flex: 0 0 50%;
        max-width: 50%;
    }
}

@media (max-width: 768px) {
    .row-cols-md-2 > * {
        flex: 0 0 100%;
        max-width: 100%;
    }
}

.bi {
    margin-right: 0.25rem;
}

.location, .dates {
    font-size: 0.85rem;
}

.litepicker {
    font-family: inherit;
    box-shadow: 0 0 20px rgba(0,0,0,0.15);
    border-radius: 8px;
}

.litepicker .container__months {
    box-shadow: none;
}

.litepicker .container__days .day-item.is-today {
    color: #0d6efd;
    font-weight: bold;
}

.litepicker .container__days .day-item.is-start-date,
.litepicker .container__days .day-item.is-end-date {
    background-color: #0d6efd;
    color: #fff;
}

.litepicker .container__days .day-item.is-in-range {
    background-color: #e9ecef;
    color: #0d6efd;
}

.litepicker .container__days .day-item:hover {
    background-color: #0d6efd;
    color: #fff;
    box-shadow: none;
}
</style>
{% endblock %} 